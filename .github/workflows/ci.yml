name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Backend checks with coverage
  backend-check:
    name: Backend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./backend -> target"

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --verbose

      - name: Run tests with coverage
        run: |
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/lcov.info
          flags: backend
          fail_ci_if_error: false

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --json | jq '.data[0].totals.lines.percent')
          echo "Coverage: $COVERAGE%"
          # Warn if coverage is below 50%
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "::warning::Backend coverage is below 50%"
          fi

  # Backend benchmarks (optional, on main only)
  backend-bench:
    name: Backend Benchmarks
    runs-on: ubuntu-latest
    needs: backend-check
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./backend -> target"

      - name: Run benchmarks
        run: cargo bench --no-run

      - name: Run benchmarks (short)
        run: cargo bench -- --warm-up-time 1 --measurement-time 2

  # Frontend checks with coverage
  frontend-check:
    name: Frontend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint -- --max-warnings 10

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Test with coverage
        run: npm test -- --run --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        working-directory: ./backend
        run: cargo audit

      - name: Check npm vulnerabilities
        working-directory: ./frontend
        run: npm audit --audit-level=high || true

  # Integration tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check]
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./backend -> target"

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create test-cluster --wait

      - name: Apply K8s manifests
        run: |
          kubectl apply -f infra/k8s/

      - name: Verify namespaces
        run: |
          kubectl get namespaces
          kubectl get ns networksim-system
          kubectl get ns networksim-sim

      - name: Build backend
        working-directory: ./backend
        run: cargo build --release

      - name: Start backend (background)
        working-directory: ./backend
        run: |
          DATABASE_URL="sqlite::memory:" ./target/release/networksim-backend &
          sleep 5

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh --backend-only

      - name: Cleanup
        if: always()
        run: |
          k3d cluster delete test-cluster || true
          pkill -9 networksim-backend || true

  # Chaos validation (on main only)
  chaos-validation:
    name: Chaos Validation
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create chaos-test --wait

      - name: Create namespace
        run: |
          kubectl create namespace networksim-sim

      - name: Install Chaos Mesh
        run: |
          helm repo add chaos-mesh https://charts.chaos-mesh.org
          helm repo update
          kubectl create namespace chaos-mesh || true
          helm install chaos-mesh chaos-mesh/chaos-mesh \
            -n chaos-mesh \
            --set chaosDaemon.runtime=containerd \
            --set chaosDaemon.socketPath=/run/k3s/containerd/containerd.sock \
            --wait --timeout 5m

      - name: Wait for Chaos Mesh
        run: |
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/instance=chaos-mesh -n chaos-mesh --timeout=300s

      - name: Run chaos validation (quick)
        run: |
          chmod +x scripts/chaos-validation.sh
          ./scripts/chaos-validation.sh --quick

      - name: Cleanup
        if: always()
        run: |
          k3d cluster delete chaos-test || true
